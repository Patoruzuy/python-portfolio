{% extends "base.html" %}

{% block title %}Blog - Python Developer Portfolio{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>Technical Blog</h1>
        <p>Insights, tutorials, and thought leadership on Python development and software engineering</p>
    </div>
</section>

<section class="blog-section">
    <div class="container">
        <div class="blog-layout">
            <!-- Main Content -->
            <div class="blog-main">
                <div class="blog-filters">
                    <button class="filter-btn active" data-category="">All Posts</button>
                    <button class="filter-btn" data-category="Python Development">Python Development</button>
                    <button class="filter-btn" data-category="Raspberry Pi">Raspberry Pi</button>
                    <button class="filter-btn" data-category="Best Practices">Best Practices</button>
                </div>
                
                <div class="blog-posts" id="blogPosts">
                    {% for post in posts %}
                    <article class="blog-post-card" data-category="{{ post.category }}">
                        <div class="post-image">
                            <img src="{{ post.image }}" alt="{{ post.title }}" onerror="this.src='/static/images/placeholder.jpg'">
                            <span class="post-category">{{ post.category }}</span>
                        </div>
                        <div class="post-content">
                            <div class="post-meta">
                                <span class="post-author">
                                    <i class="fas fa-user"></i> {{ post.author }}
                                </span>
                                <span class="post-date">
                                    <i class="far fa-calendar"></i> {{ post.date|format_date }}
                                </span>
                                <span class="post-time">
                                    <i class="far fa-clock"></i> {{ post.read_time }}
                                </span>
                            </div>
                            
                            <h2><a href="{{ url_for('blog_post', slug=post.slug) }}">{{ post.title }}</a></h2>
                            <p class="post-excerpt">{{ post.excerpt }}</p>
                            
                            <div class="post-tags">
                                {% for tag in post.tags_list %}
                                <span class="tag">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            
                            <a href="{{ url_for('blog_post', slug=post.slug) }}" class="read-more-btn">
                                Read Full Article <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Sidebar -->
            <aside class="blog-sidebar">
                <div class="sidebar-widget">
                    <h3>About the Author</h3>
                    <div class="author-info">
                        <div class="author-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <p>Experienced Python developer sharing knowledge about software engineering, IoT, and best practices.</p>
                        <a href="{{ url_for('about') }}" class="btn btn-small">Learn More</a>
                    </div>
                </div>
                
                <div class="sidebar-widget">
                    <h3>Popular Topics</h3>
                    <div class="topic-tags">
                        <a href="#" class="topic-tag">Python</a>
                        <a href="#" class="topic-tag">Django</a>
                        <a href="#" class="topic-tag">Flask</a>
                        <a href="#" class="topic-tag">Raspberry Pi</a>
                        <a href="#" class="topic-tag">IoT</a>
                        <a href="#" class="topic-tag">Machine Learning</a>
                        <a href="#" class="topic-tag">Best Practices</a>
                        <a href="#" class="topic-tag">Testing</a>
                        <a href="#" class="topic-tag">DevOps</a>
                    </div>
                </div>
                
                <div class="sidebar-widget">
                    <h3>Newsletter</h3>
                    <p>Subscribe to get the latest posts delivered to your inbox.</p>
                    <form id="blogNewsletterForm" class="newsletter-form">
                        <input type="email" id="blog-newsletter-email" name="email" placeholder="Your email address" required>
                        <input type="text" id="blog-newsletter-name" name="name" placeholder="Your name (optional)" style="margin-top: 10px;">
                        <button type="submit" class="btn btn-primary">Subscribe</button>
                    </form>
                </div>
                
                <div class="sidebar-widget">
                    <h3>Recent Posts</h3>
                    <ul class="recent-posts-list">
                        {% for post in posts[:3] %}
                        <li>
                            <a href="{{ url_for('blog_post', slug=post.slug) }}">
                                <span class="recent-post-title">{{ post.title }}</span>
                                <span class="recent-post-date">{{ post.date|format_date }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</section>

<!-- Featured Tutorial Section -->
<section class="featured-tutorial">
    <div class="container">
        <h2 class="section-title">Featured Tutorial</h2>
        <div class="tutorial-content">
            <h3>Building a RESTful API with Flask and SQLAlchemy</h3>
            <p class="tutorial-intro">Learn how to build a production-ready REST API with authentication, validation, and comprehensive error handling.</p>
            
            <div class="tutorial-steps">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Project Setup</h4>
                            <pre><code class="language-bash"># Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install flask flask-sqlalchemy flask-jwt-extended flask-marshmallow

# Create project structure
mkdir -p app/{models,routes,schemas}
touch app/__init__.py app/config.py
</code></pre>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Application Factory Pattern</h4>
                        <pre><code class="language-python"># app/__init__.py
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_jwt_extended import JWTManager
from flask_marshmallow import Marshmallow

db = SQLAlchemy()
jwt = JWTManager()
ma = Marshmallow()

def create_app(config_name='development'):
    """Application factory pattern"""
    app = Flask(__name__)
    app.config.from_object(f'app.config.{config_name.capitalize()}Config')
    
    # Initialize extensions
    db.init_app(app)
    jwt.init_app(app)
    ma.init_app(app)
    
    # Register blueprints
    from app.routes import auth, users, posts
    app.register_blueprint(auth.bp)
    app.register_blueprint(users.bp)
    app.register_blueprint(posts.bp)
    
    # Error handlers
    @app.errorhandler(404)
    def not_found(error):
        return {'error': 'Resource not found'}, 404
    
    @app.errorhandler(500)
    def internal_error(error):
        db.session.rollback()
        return {'error': 'Internal server error'}, 500
    
    return app
</code></pre>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Database Models</h4>
                        <pre><code class="language-python"># app/models/user.py
from app import db
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime

class User(db.Model):
    """User model with authentication"""
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)
    
    # Relationships
    posts = db.relationship('Post', backref='author', lazy='dynamic')
    
    def set_password(self, password):
        """Hash and set password"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Verify password"""
        return check_password_hash(self.password_hash, password)
    
    def __repr__(self):
        return f'<User {self.username}>'
</code></pre>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>API Routes with JWT Authentication</h4>
                        <pre><code class="language-python"># app/routes/users.py
from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from app import db
from app.models.user import User
from app.schemas.user import UserSchema

bp = Blueprint('users', __name__, url_prefix='/api/users')
user_schema = UserSchema()
users_schema = UserSchema(many=True)

@bp.route('/', methods=['GET'])
@jwt_required()
def get_users():
    """Get all users (protected route)"""
    users = User.query.all()
    return jsonify(users_schema.dump(users)), 200

@bp.route('/<int:user_id>', methods=['GET'])
@jwt_required()
def get_user(user_id):
    """Get specific user"""
    user = User.query.get_or_404(user_id)
    return jsonify(user_schema.dump(user)), 200

@bp.route('/<int:user_id>', methods=['PUT'])
@jwt_required()
def update_user(user_id):
    """Update user (only own profile)"""
    current_user_id = get_jwt_identity()
    
    if current_user_id != user_id:
        return {'error': 'Unauthorized'}, 403
    
    user = User.query.get_or_404(user_id)
    data = request.get_json()
    
    # Validate and update
    errors = user_schema.validate(data, partial=True)
    if errors:
        return {'errors': errors}, 400
    
    if 'username' in data:
        user.username = data['username']
    if 'email' in data:
        user.email = data['email']
    
    db.session.commit()
    return jsonify(user_schema.dump(user)), 200

@bp.route('/<int:user_id>', methods=['DELETE'])
@jwt_required()
def delete_user(user_id):
    """Delete user"""
    current_user_id = get_jwt_identity()
    
    if current_user_id != user_id:
        return {'error': 'Unauthorized'}, 403
    
    user = User.query.get_or_404(user_id)
    db.session.delete(user)
    db.session.commit()
    
    return {'message': 'User deleted successfully'}, 200
</code></pre>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="tutorial-footer">
                <p>This is just a preview. Read the full tutorial for complete implementation details, testing strategies, and deployment guides.</p>
                <a href="#" class="btn btn-primary">Read Full Tutorial</a>
            </div>
        </div>
    </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/blog-filter.js') }}"></script>
<script nonce="{{ csp_nonce() }}">
// Create newsletter modal
function createNewsletterModal() {
    const modal = document.createElement('div');
    modal.id = 'newsletter-modal';
    modal.style.cssText = `
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: var(--terminal-bg);
        border: 2px solid var(--terminal-green);
        border-radius: 4px;
        margin: 10% auto;
        padding: 0;
        max-width: 500px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    return { modal, modalContent };
}

function showNewsletterModal(message, isSuccess) {
    let modal = document.getElementById('newsletter-modal');
    let modalContent;
    
    if (!modal) {
        const created = createNewsletterModal();
        modal = created.modal;
        modalContent = created.modalContent;
    } else {
        modalContent = modal.querySelector('div');
    }
    
    const icon = isSuccess ? '✓' : '✗';
    const color = isSuccess ? 'var(--terminal-green)' : '#ff6b6b';
    
    modalContent.innerHTML = `
        <div style="padding: 30px; border-bottom: 2px solid ${color}; background: rgba(0, 0, 0, 0.3);">
            <h2 style="margin: 0; color: ${color}; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">${icon}</span>
                <span>${isSuccess ? 'Success!' : 'Error'}</span>
            </h2>
        </div>
        <div style="padding: 30px;">
            <p style="color: var(--text-color); line-height: 1.6; margin: 0; font-size: 16px;">
                ${message}
            </p>
        </div>
        <div style="padding: 20px 30px; border-top: 2px solid var(--terminal-border); display: flex; justify-content: flex-end;">
            <button onclick="closeNewsletterModal()" style="
                background: ${color};
                color: #000;
                border: none;
                padding: 10px 30px;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                cursor: pointer;
                border-radius: 4px;
                font-size: 14px;
            ">OK</button>
        </div>
    `;
    
    modal.style.display = 'block';
    
    // Close on outside click
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeNewsletterModal();
        }
    };
}

function closeNewsletterModal() {
    const modal = document.getElementById('newsletter-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Add animation keyframes
if (!document.getElementById('newsletter-modal-styles')) {
    const style = document.createElement('style');
    style.id = 'newsletter-modal-styles';
    style.textContent = `
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
}

// Newsletter subscription handler
document.getElementById('blogNewsletterForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Get form data
    const formData = {
        email: document.getElementById('blog-newsletter-email').value,
        name: document.getElementById('blog-newsletter-name').value
    };
    
    // Disable submit button
    submitBtn.disabled = true;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subscribing...';
    
    try {
        const response = await fetch('/api/newsletter/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        // Show modal instead of inline message
        showNewsletterModal(data.message || data.error, data.success);
        
        // Clear form on success
        if (data.success) {
            form.reset();
        }
        
    } catch (error) {
        showNewsletterModal('Subscription failed. Please try again later.', false);
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});
</script>
{% endblock %}
